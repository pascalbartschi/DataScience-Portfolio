---
title: "Measurement Error Analysis"
author: "Your Name"
output:
  html_document:
    toc: true
    toc_depth: 5
output_dir: "../html"
date: "`r Sys.Date()`"
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

### Introduction

In this document, we will analyze measurement errors and perform various statistical analyses using the provided dataset. Each section will focus on specific tasks such as data loading, exploratory data analysis, linear regression, mixed effects modeling, and simex analysis. Interpretation of function outputs and results will be provided through comments in the code.

```{r}

# Load required libraries
suppressPackageStartupMessages({
  library("ggplot2")
  library("dplyr")
  library("ggfortify")
  library('tidyverse')
  library('GGally')
  library('MASS')
  library('readr')
  library(lme4)
  library(simex)
})
```

Data Loading

Let's start by loading the data set created in class.

```{r}

# Load the dataset from URL
the_URL <- "https://docs.google.com/spreadsheets/d/e/2PACX-1vQDI5oZ54MD4Qm_WDydUAWgRYX1PRWMoOWJCSFN5mZJ6Yf-irKq_n6-7CyPsJ13BoEksusqRUBdcgii/pub?gid=133427610&single=true&output=csv"
class_RTs <- read.csv(the_URL)
```

### Data Preprocessing

Let's perform data preprocessing tasks such as renaming columns.

```{r}

# Rename columns for clarity
names(class_RTs) <- c("Timestamp", "ID", "Gender", "Weight", "Handedness", "PRT_1",
                      "PRT_2", "PRT_3", "PRT_4", "PRT_5", "avg_PRT",
                      "Nonpref_RT_ave", "Verbal_memory_score", "Number_memory_score",
                      "Visual_memory_score", "Random_number")
```

### Exploratory Data Analysis

Let's visualize the data to gain insights into the relationships between variables.

```{r}

# Gather data for better visualization
gathered <- gather(class_RTs, key = Number, value =  'PRT', "PRT_1",
                   "PRT_2", "PRT_3", "PRT_4", "PRT_5", "avg_PRT")

# Create boxplot by gender
ggplot(gathered, aes(x = ID, y = PRT)) +
  geom_boxplot() +
  facet_wrap(~Gender) +
  theme_bw() + 
  theme(axis.text.x = element_blank())
```

### Linear Regression Analysis

We'll perform linear regression analysis on the data.

#### Model 1: Averaged Reaction Time

Fitting a linear regression model using averaged reaction times.

```{r}

# Fit a linear regression model
m1 <- lm(avg_PRT ~ Gender, class_RTs)
summary(m1)
anova(m1)
```

#### Model 2: Individual Reaction Times

Fitting a linear regression model without averaging, accounting for multiple observations.

```{r}

# Fit a linear regression model without averaging
m2 <- lm(PRT ~ Gender, gathered)
summary(m2)
anova(m2)
```

### Mixed Effects Model

### We'll fit a mixed effects model to account for individual variability.

```{r}

# Fit a mixed effects model
lmm1 <- lmer(PRT ~ Gender + (1|ID), data = gathered, REML = F)
null_m <- lmer(PRT ~ (1|ID), data = gathered, REML = F)
summary(lmm1)
confint(lmm1)
anova(null_m, lmm1)
```

### Measurement Error Analysis

We'll analyze measurement errors using the provided dataset.

```{r}

# Load the dataset again for measurement error analysis
dd <- read.csv(the_URL)

# Preprocess the data
names(dd) <- c("Timestamp", "ID", "Gender", "Weight", "Handedness", "PRT_1",
               "PRT_2", "PRT_3", "PRT_4", "PRT_5", "Pref_RT_ave",
               "Nonpref_RT_ave", "Verbal_memory_score", "Number_memory_score",
               "Visual_memory_score", "Random_number")

# Filter out data for analysis
dd_filtered <- dd %>%
  filter(Pref_RT_ave >  50 & Pref_RT_ave < 500)

# Create a scatter plot for measurement error
ggplot(dd_filtered, aes(x = Pref_RT_ave, y = Nonpref_RT_ave)) +
  geom_point(color = 'blue') + 
  geom_point(data = dd_filtered, mapping = aes(x = PRT_1, y = Nonpref_RT_ave), color = 'red') +
  xlim(c(0,500)) +
  ylim(c(0,500)) +
  theme_bw()
```

### SIMEX Analysis

We'll perform SIMEX analysis to account for measurement errors in regression.

```{r}
# Fit linear regression for SIMEX analysis
r.lm <- lm(Nonpref_RT_ave ~ Pref_RT_ave, dd_filtered, x= TRUE)

# Estimate the error variance
temp <- dplyr::select(dd_filtered,
                      PRT_1,
                      PRT_2,
                      PRT_3,
                      PRT_4,
                      PRT_5)
error_var <- sum((temp - rowMeans(temp))^2) / (nrow(temp)*4) / 5

# Perform SIMEX analysis
measurement.error <- sqrt(error_var)
lambda <- seq(0.1, 2, 0.1)
B <- 50
r.simex <- simex(r.lm, SIMEXvariable = "Pref_RT_ave", 
                 measurement.error = measurement.error, lambda = lambda, 
                 B = B, fitting.method = 'quadratic')

```

### Conclusion

In this analysis, we explored measurement error analysis using the provided dataset. We performed data loading, preprocessing, exploratory data analysis, linear regression, mixed effects modeling, and SIMEX analysis. The document demonstrates how to handle measurement errors and perform various statistical analyses to gain insights from the data.